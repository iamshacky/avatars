<!doctype html>
<meta charset="utf-8" />
<title>Avatar (V2 modular)</title>
<style>
  body { font-family: system-ui, sans-serif; max-width: 720px; margin: 24px auto; }
  #face { width: 240px; height: 240px; border-radius: 50%; background: #eee;
          display: grid; place-items: center; margin: 16px 0; }
  #mouth { width: 80px; height: 12px; border-radius: 10px; background: #333;
           transition: height 60ms; }
  textarea, button, select, input { font-size: 16px; }
  #status { font-size: 12px; color: #666; }
</style>
<body>
  <h1>Avatar (voice + lip-sync)</h1>

  <div id="face"><div id="mouth"></div></div>
  <audio id="avatar-audio" autoplay></audio>

  <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <label>Provider:
      <select id="provider">
        <option value="openai">OpenAI</option>
        <option value="microsoft">Microsoft</option>
        <!--<option value="piper">Piper</option> -->
      </select>
    </label>
    <label>Voice:
      <select id="voice">
        <option>alloy</option>
        <option>verse</option>
        <option>aria</option>
        <option>sage</option>
      </select>
    </label>
    <label>Rate:
      <select id="rate">
        <option value="24000">24k</option>
        <option value="48000">48k</option>
      </select>
    </label>
    <label>Format:
      <select id="fmt">
        <option>mp3</option>
        <option>wav</option>
      </select>
    </label>
  </div>

  <!--<div id="status">status: idle</div>-->
  <div id="status" style="font-size:12px;color:#666">status: idle</div>

  <textarea id="text" rows="3" style="width:100%;margin:10px 0;">Hey! I’m a modular avatar (V2). Built to swap TTS/LLMs later.</textarea>
  <div>
    <button id="say">Speak</button>
  </div>

  <script type="module">
    import { WebAudioPlayer } from '/audio/outputs/webAudioPlayer.js';
    import { AvatarController } from '/avatar/core/controller.js';
    import { Dom2DRenderer } from '/avatar/renderers/dom2d.js';

    const audioEl = document.getElementById('avatar-audio');
    const statusEl = document.getElementById('status');
    const player = new WebAudioPlayer(audioEl);

    const renderer = new Dom2DRenderer(document.body);
    const avatar = new AvatarController(renderer, player.getAnalyser());

    function loop(){
      avatar.update();
      avatar.render();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    const providerEl = document.getElementById('provider');
    const voiceEl    = document.getElementById('voice');
    const rateEl     = document.getElementById('rate');
    const fmtEl      = document.getElementById('fmt');

    async function speak(text) {
      const url = `/api/tts?` + new URLSearchParams({
        text,
        voice: voiceEl.value,
        rate: rateEl.value,
        fmt: fmtEl.value,
        provider: providerEl.value
      });
      /*
      statusEl.textContent = 'status: requesting TTS…';
      const t0 = performance.now();
      try {
        await player.play(url);
        const ms = Math.round(performance.now() - t0);
        statusEl.textContent = `status: playing (TTS RTT ${ms} ms)`;
      } catch (e) {
        statusEl.textContent = 'status: error starting audio';
        console.warn(e);
      }
      */
      /**/
      statusEl.textContent = `status: requesting TTS (${providerEl.value})…`;
      const t0 = performance.now();
      try {
        await player.play(url);
        const ms = Math.round(performance.now() - t0);
        statusEl.textContent = `status: playing (${providerEl.value}), TTS RTT ${ms} ms`;
      } catch (e) {
        statusEl.textContent = `status: error (${providerEl.value}): ${e?.message || e}`;
      }
    }

    document.getElementById('say').onclick = async () => {
      const t = document.getElementById('text').value.trim();
      if (!t) return;
      await speak(t);
    };

    // ensure audio context can play
    window.addEventListener('click', () => player.ctx.resume().catch(()=>{}), { once: true });
  </script>
</body>
